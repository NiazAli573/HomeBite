{% extends 'base.html' %}
{% load static %}

{% block title %}Browse Meals - HomeBite{% endblock %}

{% block content %}
<div style="background-color: #F8F9FA; min-height: 100vh; padding: 2rem 0;">
    <div class="container-lg">
        <!-- Header -->
        <div style="margin-bottom: 2.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <i class="bi bi-egg-fried" style="font-size: 2rem; color: #FF6B35;"></i>
                <div>
                    <h1 style="font-size: 2rem; font-weight: 900; color: #212529; margin-bottom: 0.25rem;">Browse Meals</h1>
                    <p style="color: #757575; margin-bottom: 0; font-weight: 300;">Discover fresh meals from local cooks near you</p>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- Filters Sidebar -->
            <div class="col-lg-3">
                <div class="card border-0" style="border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.08); position: sticky; top: 1rem;">
                    <div style="background: linear-gradient(135deg, #FF6B35, #E55A24); padding: 1.5rem; border-radius: 1rem 1rem 0 0; color: white;">
                        <h6 style="margin-bottom: 0; font-weight: 700; font-size: 1.1rem;">
                            <i class="bi bi-funnel me-2"></i> Filters
                        </h6>
                    </div>
                    
                    <div class="card-body p-4">
                        <form method="get" id="filterForm">
                            <!-- Search -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="font-weight: 600; color: #212529; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Search Meals</label>
                                <input type="text" name="search" placeholder="Search by meal name..." class="form-control" style="border: 2px solid #E0E0E0; border-radius: 0.5rem; padding: 0.75rem; transition: all 0.2s;">
                            </div>
                            
                            <!-- Distance -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="font-weight: 600; color: #212529; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Max Distance (km)</label>
                                <select name="max_distance" class="form-select" style="border: 2px solid #E0E0E0; border-radius: 0.5rem; padding: 0.75rem;">
                                    <option value="">All distances</option>
                                    <option value="0.5">0.5 km</option>
                                    <option value="1">1 km</option>
                                    <option value="2">2 km</option>
                                    <option value="5">5 km</option>
                                    <option value="10">10 km</option>
                                </select>
                            </div>
                            
                            <!-- Price -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="font-weight: 600; color: #212529; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Max Price (PKR)</label>
                                <input type="number" name="max_price" placeholder="Enter max price..." class="form-control" style="border: 2px solid #E0E0E0; border-radius: 0.5rem; padding: 0.75rem;">
                            </div>
                            
                            <!-- Sort -->
                            <div style="margin-bottom: 2rem;">
                                <label style="font-weight: 600; color: #212529; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Sort By</label>
                                <select name="sort_by" class="form-select" style="border: 2px solid #E0E0E0; border-radius: 0.5rem; padding: 0.75rem;">
                                    <option value="-created_at">Newest First</option>
                                    <option value="price">Price: Low to High</option>
                                    <option value="-price">Price: High to Low</option>
                                    <option value="distance">Distance: Nearest</option>
                                </select>
                            </div>
                            
                            <input type="hidden" name="lat" id="filter_lat" value="{{ customer_lat|default:'' }}">
                            <input type="hidden" name="lng" id="filter_lng" value="{{ customer_lng|default:'' }}">
                            
                            <button type="submit" style="width: 100%; background: linear-gradient(135deg, #FF6B35, #E55A24); color: white; border: none; padding: 0.875rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.boxShadow='0 8px 20px rgba(255,107,53,0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <i class="bi bi-search me-2"></i> Apply Filters
                            </button>
                        </form>
                        
                        {% if not has_location %}
                        <hr style="margin: 1.5rem 0; border-color: #E0E0E0;">
                        <div style="text-align: center;">
                            <p style="color: #757575; font-size: 0.9rem; margin-bottom: 1rem; font-weight: 300;">Set your location to see nearby meals</p>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setLocation()" style="border: 2px solid #FF6B35;">
                                <i class="bi bi-geo-alt me-1"></i> Set Location
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Meals Grid -->
            <div class="col-lg-9">
                {% if meals %}
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    {% for item in meals %}
                    <div class="card border-0 overflow-hidden" style="border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.08)'">
                        <!-- Image -->
                        <div style="position: relative; overflow: hidden; height: 200px; background-color: #F0F0F0;">
                            {% if item.meal.photo %}
                            <img src="{{ item.meal.photo.url }}" alt="{{ item.meal.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;">
                            {% else %}
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #F0F0F0, #E8E8E8);">
                                <i class="bi bi-image" style="font-size: 3rem; color: #BDBDBD;"></i>
                            </div>
                            {% endif %}
                            
                            <!-- Badges -->
                            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                {% if item.distance is not None %}
                                <div style="background: white; padding: 0.5rem 0.75rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; color: #FF6B35; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <i class="bi bi-geo-alt me-1"></i>{{ item.distance }} km
                                </div>
                                {% endif %}
                                {% if item.meal.quantity_available <= 0 %}
                                <div style="background: #E74C3C; color: white; padding: 0.5rem 0.75rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">
                                    Sold Out
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="card-body p-4">
                            <h5 style="font-weight: 700; color: #212529; margin-bottom: 0.5rem; font-size: 1.1rem;">{{ item.meal.name }}</h5>
                            
                            <!-- Cook Info -->
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: #757575;">
                                <i class="bi bi-person-circle"></i>
                                <span>{{ item.meal.cook.user.username }}</span>
                                {% if item.meal.cook.rating > 0 %}
                                <div style="margin-left: auto; display: flex; align-items: center; gap: 0.25rem; color: #F39C12;">
                                    <i class="bi bi-star-fill" style="font-size: 0.9rem;"></i>
                                    <span style="font-weight: 600;">{{ item.meal.cook.rating }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Details -->
                            <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.9rem; color: #757575;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-clock" style="color: #FF6B35; font-size: 1rem;"></i>
                                    <span>Ready at {{ item.meal.ready_time|time:"H:i" }}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-basket" style="color: #FF6B35; font-size: 1rem;"></i>
                                    <span>{{ item.meal.quantity_available }} available</span>
                                </div>
                            </div>
                            
                            <!-- Price -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; border-top: 1px solid #E0E0E0; padding-top: 1rem;">
                                <span style="font-size: 1.5rem; font-weight: 900; color: #FF6B35;">PKR {{ item.meal.price }}</span>
                                <a href=\"{% url 'meals:detail' item.meal.pk %}\" style="background: linear-gradient(135deg, #FF6B35, #E55A24); color: white; border: none; padding: 0.6rem 1rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; text-decoration: none; font-size: 0.9rem; transition: all 0.3s;\" onmouseover=\"this.style.boxShadow='0 6px 16px rgba(255,107,53,0.3)'; this.style.transform='translateY(-2px)'\" onmouseout=\"this.style.boxShadow='none'; this.style.transform='translateY(0)'\">
                                    <i class="bi bi-eye me-1"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty State -->
                <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.08);">
                    <i class="bi bi-search" style="font-size: 4rem; color: #E0E0E0; display: block; margin-bottom: 1rem;"></i>
                    <h4 style="color: #212529; font-weight: 700; margin-bottom: 0.5rem; font-size: 1.5rem;">No Meals Found</h4>
                    <p style="color: #757575; font-weight: 300; margin-bottom: 2rem;">Try adjusting your filters, location, or search query</p>
                    <button type="button" class="btn" style="background: linear-gradient(135deg, #FF6B35, #E55A24); color: white; padding: 0.75rem 1.5rem; font-weight: 600; border: none; border-radius: 0.5rem;" onclick="setLocation()">
                        <i class="bi bi-geo-alt me-2"></i> Set My Location
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" style="backdrop-filter: blur(4px);">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0" style="border-radius: 1rem; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
            <div style="background: linear-gradient(135deg, #FF6B35, #E55A24); padding: 1.5rem; border-radius: 1rem 1rem 0 0; color: white;">
                <h5 style="margin-bottom: 0; font-weight: 700; font-size: 1.2rem;">
                    <i class="bi bi-geo-alt me-2"></i> Set Your Location
                </h5>
            </div>
            
            <div class="modal-body p-4">
                <p style="color: #757575; margin-bottom: 1.5rem; font-weight: 300;">Click on the map to set your location, or use the current location button.</p>
                <div id="locationMap" style="height: 400px; border-radius: 0.75rem; border: 2px solid #E0E0E0; margin-bottom: 1.5rem;"></div>
                <div style="text-align: center;">
                    <button type="button" class="btn" onclick="getCurrentLocation()" style="background: linear-gradient(135deg, #27AE60, #229954); color: white; padding: 0.75rem 1.5rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
                        <i class="bi bi-crosshairs me-2"></i> Use My Location
                    </button>
                </div>
            </div>
            
            <div class="modal-footer border-top-0 p-4">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" style="border: 2px solid #E0E0E0; background: white; color: #212529; font-weight: 600;">Cancel</button>
                <button type="button" class="btn" onclick="applyLocation()" style="background: linear-gradient(135deg, #FF6B35, #E55A24); color: white; font-weight: 600; border: none;">
                    <i class="bi bi-check me-2"></i> Apply Location
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    var locationMap = null;
    var locationMarker = null;
    var selectedLat = {{ customer_lat|default:"null" }};
    var selectedLng = {{ customer_lng|default:"null" }};
    
    function setLocation() {
        var modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
        
        setTimeout(function() {
            if (!locationMap) {
                var defaultLat = selectedLat || 24.8607;
                var defaultLng = selectedLng || 67.0011;
                
                locationMap = L.map('locationMap').setView([defaultLat, defaultLng], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(locationMap);
                
                if (selectedLat && selectedLng) {
                    locationMarker = L.marker([selectedLat, selectedLng]).addTo(locationMap);
                }
                
                locationMap.on('click', function(e) {
                    setMapMarker(e.latlng.lat, e.latlng.lng);
                });
            }
            locationMap.invalidateSize();
        }, 300);
    }
    
    function setMapMarker(lat, lng) {
        if (locationMarker) {
            locationMap.removeLayer(locationMarker);
        }
        locationMarker = L.marker([lat, lng]).addTo(locationMap);
        selectedLat = lat;
        selectedLng = lng;
    }
    
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                setMapMarker(lat, lng);
                locationMap.setView([lat, lng], 15);
            }, function(error) {
                alert('Could not get your location. Please click on the map instead.');
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    }
    
    function applyLocation() {
        if (selectedLat && selectedLng) {
            document.getElementById('filter_lat').value = selectedLat.toFixed(6);
            document.getElementById('filter_lng').value = selectedLng.toFixed(6);
            document.getElementById('filterForm').submit();
        } else {
            alert('Please select a location on the map first.');
        }
    }
</script>
{% endblock %}
